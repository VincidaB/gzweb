!function(e,s){"object"==typeof exports&&"undefined"!=typeof module?s(exports,require("rxjs"),require("protobufjs")):"function"==typeof define&&define.amd?define(["exports","rxjs","protobufjs"],s):s((e="undefined"!=typeof globalThis?globalThis:e||self).gzweb={},e.rxjs,e.protobufjs)}(this,(function(e,s,t){"use strict";let i={},n=null,o=null;function a(){for(var e in function(){for(var e=navigator.getGamepads(),s=0;s<e.length;s++)r(e[s])}(),i){let s=i[e];for(let e=0;e<s.gamepad.buttons.length;e++){let t=s.gamepad.buttons[e];s.prevButtons[e]!==t.pressed&&(s.prevButtons[e]=t.pressed,n(s,{index:e,pressed:t.pressed}))}for(let e=0;e<s.gamepad.axes.length;e++){let t=s.gamepad.axes[e];s.prevAxes[e]!==t&&(s.prevAxes[e]=t,o(s,{index:e,axis:t}))}}requestAnimationFrame(a)}function r(e){if(e)if(e.index in i)i[e.index].gamepad=e;else{console.log("Adding gamepad",e.id),i[e.index]={gamepad:e,prevButtons:new Array(e.buttons.length),prevAxes:new Array(e.axes.length)};for(var s=0;s<e.buttons.length;s++)i[e.index].prevButtons[s]=!1;for(var t=0;t<e.axes.length;t++)i[e.index].prevAxes[t]=0}}function c(e){r(e.gamepad)}function d(e){var s;(s=e.gamepad)&&s.index in i&&delete i[s.index]}class h{constructor(e,s){this.name=e,this.cb=s}}class l{constructor(){this.status$=new s.BehaviorSubject("disconnected"),this.sceneInfo$=new s.BehaviorSubject(null),this.availableTopics=[],this.topicMap=new Map,this.assetMap=new Map,this.world=""}connect(e,s){this.disconnect(),this.ws=new WebSocket(e),this.ws.onopen=()=>this.onOpen(s),this.ws.onclose=()=>this.onClose(),this.ws.onmessage=e=>this.onMessage(e),this.ws.onerror=e=>this.onError(e)}disconnect(){this.ws&&this.ws.close()}subscribe(e){this.topicMap.set(e.name,e);const s=this.availableTopics.filter((s=>s.topic===e.name))[0];"ignition.msgs.Image"===s.msg_type||"gazebo.msgs.Image"===s.msg_type?this.ws.send(this.buildMsg(["image",e.name,"",""])):this.ws.send(this.buildMsg(["sub",e.name,"",""]))}unsubscribe(e){if(this.topicMap.has(e)){const s=this.topicMap.get(e);void 0!==s&&void 0!==s.unsubscribe&&s.unsubscribe(),this.topicMap.delete(e),this.ws.send(this.buildMsg(["unsub",e,"",""]))}}throttle(e,s){this.ws.send(this.buildMsg(["throttle",e.name,"na",s.toString()]))}getAvailableTopics(){return this.availableTopics}getSubscribedTopics(){return this.topicMap}getWorld(){return this.world}getAsset(e,s){let t={uri:e,cb:s};this.assetMap.set(e,t),this.ws.send(this.buildMsg(["asset","","",e]))}onOpen(e){e?this.ws.send(this.buildMsg(["auth","","",e])):this.ws.send(this.buildMsg(["protos","","",""]))}onClose(){this.topicMap.clear(),this.availableTopics=[],this.root=null,this.status$.next("disconnected"),this.sceneInfo$.next(null)}onMessage(e){const s=new FileReader;if(!this.root)return s.onloadend=()=>{switch(s.result){case"authorized":this.ws.send(this.buildMsg(["protos","","",""]));break;case"invalid":console.error("Invalid key");break;default:this.root=t.parse(s.result,{keepCase:!0}).root,this.ws.send(this.buildMsg(["topics-types","","",""])),this.ws.send(this.buildMsg(["worlds","","",""])),this.status$.next("connected")}},void s.readAsText(e.data);s.onloadend=()=>{var e,t,i,n;if(!this.root)return void console.error("Protobuf root has not been created");if("disconnected"===this.status$.getValue())return;const o=new TextDecoder("utf-8").decode(s.result).split(","),a=this.root.lookup(o[2]);let r;const c=new Uint8Array(s.result).slice(o[0].length+o[1].length+o[2].length+3);if(r="ignition.msgs.Image"===o[2]||"gazebo.msgs.Image"===o[2]?c:a.decode(c),"asset"==o[0])this.assetMap.has(o[1])?null===(t=null===(e=null==this?void 0:this.assetMap)||void 0===e?void 0:e.get(o[1]))||void 0===t||t.cb(r.data):console.error("No resource callback");else if("pub"==o[0])switch(o[1]){case"topics-types":for(const e of r.publisher)this.availableTopics.push(e);break;case"topics":this.availableTopics=r.data;break;case"worlds":this.world=r.data[0],this.ws.send(this.buildMsg(["scene",this.world,"",""]));break;case"scene":this.sceneInfo$.next(r),this.status$.next("ready");break;default:this.topicMap.has(o[1])&&(null===(n=null===(i=null==this?void 0:this.topicMap)||void 0===i?void 0:i.get(o[1]))||void 0===n||n.cb(r))}else console.warn("Unhandled websocket message with frame operation",o[0])},s.readAsArrayBuffer(e.data)}onError(e){this.status$.next("error"),this.disconnect(),console.error(e)}buildMsg(e){return e.join(",")}}/Mobi/.test(navigator.userAgent),e.Asset=class{constructor(e,s){this.uri=e,this.cb=s}},e.Gamepad=class{constructor(e,s){n=e,o=s,window.addEventListener("gamepadconnected",c),window.addEventListener("gamepaddisconnected",d),requestAnimationFrame(a)}},e.SceneManager=class{constructor(e,s,t){this.connectionStatus="disconnected",this.models=[],this.transport=new l,this.elementId="gz-scene",void 0!==e&&(this.elementId=e),void 0!==s&&this.connect(s,t)}destroy(){this.disconnect(),this.cancelAnimation&&cancelAnimationFrame(this.cancelAnimation),this.scene&&this.scene.cleanup()}getConnectionStatus(){return this.connectionStatus}resize(){this.scene&&this.scene.setSize(this.sceneElement.clientWidth,this.sceneElement.clientHeight)}snapshot(){this.scene&&this.scene.saveScreenshot(this.transport.getWorld())}resetView(){this.scene&&this.scene.resetView()}follow(e){this.scene&&this.scene.emitter.emit("follow_entity",e)}moveTo(e){this.scene&&this.scene.emitter.emit("move_to_entity",e)}select(e){this.scene&&this.scene.emitter.emit("select_entity",e)}getModels(){return this.models}disconnect(){this.sceneElement&&this.sceneElement.childElementCount>0&&this.sceneElement.removeChild(this.scene.scene.renderer.domElement),this.transport.disconnect(),this.sceneInfo={},this.connectionStatus="disconnected",this.sceneInfoSubscription&&this.sceneInfoSubscription.unsubscribe(),this.particleEmittersSubscription&&this.particleEmittersSubscription.unsubscribe(),this.statusSubscription&&this.statusSubscription.unsubscribe()}connect(e,s){this.transport.connect(e,s),this.statusSubscription=this.transport.status$.subscribe((e=>{"error"===e&&console.log("Connection failed. Please contact an administrator."),this.connectionStatus=e,"connected"===e&&this.setupVisualization(),"ready"===e&&this.subscribeToTopics()})),this.sceneInfoSubscription=this.transport.sceneInfo$.subscribe((e=>{e&&("sky"in e&&e.sky&&this.scene.addSky(),this.sceneInfo=e,this.startVisualization(),e.model.forEach((e=>{const s=this.sdfParser.spawnFromObj({model:e},{enableLights:!1});console.log("Adding model",e),e.gz3dName=s.name,this.models.push(e),this.scene.add(s)})),e.light.forEach((e=>{const s=this.sdfParser.spawnLight(e);this.scene.add(s)})),void 0!==e.ambient&&null!==e.ambient&&(this.scene.ambient.color=new THREE.Color(e.ambient.r,e.ambient.g,e.ambient.b)))}))}subscribeToTopics(){const e=new h(`/world/${this.transport.getWorld()}/dynamic_pose/info`,(e=>{e.pose.forEach((e=>{let s=`${e.name}${e.id}`;const t=this.scene.getByName(s);t?("box"===e.name&&e.position.z>1&&console.log("Box pose",e),this.scene.setPose(t,e.position,e.orientation)):console.warn("Unable to find entity with name ",s)}))}));this.transport.subscribe(e);const s=new h(`/world/${this.transport.getWorld()}/scene/info`,(e=>{e&&e.model.forEach((e=>{let s=-1;for(let t=0;t<this.models.length;++t)if(this.models[t].name===e.name){s=t;break}if(s<0){this.scene.getByName();const s=this.sdfParser.spawnFromObj({model:e},{enableLights:!1});e.gz3dName=s.name,console.log("Adding model",e),this.models.push(e),this.scene.add(s)}else this.models[s].gz3dName=`${e.name}${e.id}`,this.models[s].id=e.id}))}));this.transport.subscribe(s)}setupVisualization(){var e=this;this.scene=new GZ3D.Scene(new GZ3D.Shaders,void 0,void 0,void 0,(function(s,t){e.transport.getAsset(s,t)})),this.sdfParser=new GZ3D.SdfParser(this.scene),this.sdfParser.usingFilesUrls=!0,window.document.getElementById(this.elementId)?this.sceneElement=window.document.getElementById(this.elementId):console.error("Unable to find HTML element with an id of",this.elementId),this.sceneElement.appendChild(this.scene.renderer.domElement),this.scene.setSize(this.sceneElement.clientWidth,this.sceneElement.clientHeight)}startVisualization(){const e=()=>{this.scene.render(),this.cancelAnimation=requestAnimationFrame((()=>{e()}))};e()}},e.Topic=h,e.Transport=l,e.binaryToBase64=function(e){for(var s="",t=e.byteLength,i=0;i<t;i++)s+=String.fromCharCode(e[i]);return window.btoa(s)},Object.defineProperty(e,"__esModule",{value:!0})}));
