!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("rxjs"),require("protobufjs")):"function"==typeof define&&define.amd?define(["exports","rxjs","protobufjs"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).gzweb={},e.rxjs,e.protobufjs)}(this,(function(e,t,n){"use strict";function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}function o(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function a(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,s=new Array(t);n<t;n++)s[n]=e[n];return s}function r(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return a(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?a(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var s=0,i=function(){};return{s:i,n:function(){return s>=e.length?{done:!0}:{done:!1,value:e[s++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,r=!0,c=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return r=e.done,e},e:function(e){c=!0,o=e},f:function(){try{r||null==n.return||n.return()}finally{if(c)throw o}}}}var c=o((function e(t,n){s(this,e),this.uri=t,this.cb=n})),u=function(){function e(t,n){s(this,e),this.controllers={},this.onButtonCb=null,this.onAxisCb=null,this.onButtonCb=t,this.onAxisCb=n,window.addEventListener("gamepadconnected",handleGamepadConnect),window.addEventListener("gamepaddisconnected",handleGamepadDisconnect),requestAnimationFrame(this.updateGamepads)}return o(e,[{key:"updateGamepads",value:function(e){function t(){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}((function(){for(var e in this.scanGamepads(),this.controllers){for(var t=this.controllers[e],n=0;n<t.gamepad.buttons.length;n++){var s=t.gamepad.buttons[n];t.prevButtons[n]!==s.pressed&&this.onButtonCb({index:n,pressed:s.pressed}),t.prevButtons[n]=s.pressed}for(var i=0;i<t.gamepad.axes.length;i+=2)t.prevAxes[i]===t.gamepad.axes[i]&&t.prevAxes[i+1]===t.gamepad.axes[i+1]||this.onAxisCb({index:(i/2).toFixed(0),x:t.gamepad.axes[i],y:t.gamepad.axes[i+1]}),t.prevAxes[i]=t.gamepad.axes[i],t.prevAxes[i+1]=t.gamepad.axes[i+1]}requestAnimationFrame(updateGamepads)}))},{key:"scanGamepads",value:function(){for(var e=navigator.getGamepads(),t=0;t<e.length;t++)this.addGamepad(e[t])}},{key:"addGamepad",value:function(e){if(e)if(e.index in this.controllers)this.controllers[e.index].gamepad=e;else{console.log("Adding gamepad",e.id),this.controllers[e.index]={gamepad:e,prevButtons:new Array(e.buttons.length),prevAxes:new Array(e.axes.length)};for(var t=0;t<e.buttons.length;t++)this.controllers[e.index].prevButtons[t]=!1;for(var n=0;n<e.axes.length;n++)this.controllers[e.index].prevAxes[n]=0}}},{key:"removeGamepad",value:function(e){e&&e.index in this.controllers&&delete this.controllers[e.index]}},{key:"handleGamepadConnect",value:function(e){addGamepad(e.gamepad)}},{key:"handleGamepadDisconnect",value:function(e){removeGamepad(e.gamepad)}}]),e}(),l=o((function e(t,n){s(this,e),this.name=t,this.cb=n})),d=function(){function e(){s(this,e),this.status$=new t.BehaviorSubject("disconnected"),this.sceneInfo$=new t.BehaviorSubject({}),this.availableTopics=[],this.topicMap=new Map,this.assetMap=new Map,this.world=""}return o(e,[{key:"connect",value:function(e,t){var n=this;this.disconnect(),this.ws=new WebSocket(e),this.ws.onopen=function(){return n.onOpen(t)},this.ws.onclose=function(){return n.onClose()},this.ws.onmessage=function(e){return n.onMessage(e)},this.ws.onerror=function(e){return n.onError(e)}}},{key:"disconnect",value:function(){this.ws&&this.ws.close()}},{key:"subscribe",value:function(e){this.topicMap.set(e.name,e);var t=this.availableTopics.filter((function(t){return t.topic===e.name}))[0];"ignition.msgs.Image"===t.msg_type||"gazebo.msgs.Image"===t.msg_type?this.ws.send(this.buildMsg(["image",e.name,"",""])):this.ws.send(this.buildMsg(["sub",e.name,"",""]))}},{key:"unsubscribe",value:function(e){if(this.topicMap.has(e)){var t=this.topicMap.get(e);void 0!==t&&void 0!==t.unsubscribe&&t.unsubscribe(),this.topicMap.delete(e),this.ws.send(this.buildMsg(["unsub",e,"",""]))}}},{key:"throttle",value:function(e,t){this.ws.send(this.buildMsg(["throttle",e.name,"na",t.toString()]))}},{key:"getAvailableTopics",value:function(){return this.availableTopics}},{key:"getSubscribedTopics",value:function(){return this.topicMap}},{key:"getWorld",value:function(){return this.world}},{key:"getAsset",value:function(e,t){var n={uri:e,cb:t};this.assetMap.set(e,n),this.ws.send(this.buildMsg(["asset","","",e]))}},{key:"onOpen",value:function(e){e?this.ws.send(this.buildMsg(["auth","","",e])):this.ws.send(this.buildMsg(["protos","","",""]))}},{key:"onClose",value:function(){this.topicMap.clear(),this.availableTopics=[],this.root=null,this.status$.next("disconnected"),this.sceneInfo$.next({})}},{key:"onMessage",value:function(e){var t=this,s=new FileReader;if(!this.root)return s.onloadend=function(){switch(s.result){case"authorized":t.ws.send(t.buildMsg(["protos","","",""]));break;case"invalid":console.error("Invalid key");break;default:t.root=n.parse(s.result,{keepCase:!0}).root,t.ws.send(t.buildMsg(["topics-types","","",""])),t.ws.send(t.buildMsg(["worlds","","",""])),t.status$.next("connected")}},void s.readAsText(e.data);s.onloadend=function(){var e,n,i,o;if(t.root){if("disconnected"!==t.status$.getValue()){var a,c=new TextDecoder("utf-8").decode(s.result).split(","),u=t.root.lookup(c[2]),l=new Uint8Array(s.result).slice(c[0].length+c[1].length+c[2].length+3);if(a="ignition.msgs.Image"===c[2]||"gazebo.msgs.Image"===c[2]?l:u.decode(l),"asset"==c[0])t.assetMap.has(c[1])?null===(n=null===(e=null==t?void 0:t.assetMap)||void 0===e?void 0:e.get(c[1]))||void 0===n||n.cb(a.data):console.error("No resource callback");else if("pub"==c[0])switch(c[1]){case"topics-types":var d,h=r(a.publisher);try{for(h.s();!(d=h.n()).done;){var f=d.value;t.availableTopics.push(f)}}catch(e){h.e(e)}finally{h.f()}break;case"topics":t.availableTopics=a.data;break;case"worlds":t.world=a.data[0],t.ws.send(t.buildMsg(["scene",t.world,"",""]));break;case"scene":t.sceneInfo$.next(a),t.status$.next("ready");break;default:t.topicMap.has(c[1])&&(null===(o=null===(i=null==t?void 0:t.topicMap)||void 0===i?void 0:i.get(c[1]))||void 0===o||o.cb(a))}else console.warn("Unhandled websocket message with frame operation",c[0])}}else console.error("Protobuf root has not been created")},s.readAsArrayBuffer(e.data)}},{key:"onError",value:function(e){this.status$.next("error"),this.disconnect(),console.error(e)}},{key:"buildMsg",value:function(e){return e.join(",")}}]),e}(),h=function(){function e(){s(this,e),this.connectionStatus="disconnected",this.models=[],this.transport=new d}return o(e,[{key:"destroy",value:function(){this.disconnect(),this.cancelAnimation&&cancelAnimationFrame(this.cancelAnimation),this.scene&&this.scene.cleanup()}},{key:"getConnectionStatus",value:function(){return this.connectionStatus}},{key:"disconnect",value:function(){this.sceneElement=window.document.getElementById("scene"),this.sceneElement&&this.sceneElement.childElementCount>0&&this.sceneElement.removeChild(this.scene.scene.renderer.domElement),this.transport.disconnect(),this.sceneInfo={},this.connectionStatus="disconnected",this.sceneInfoSubscription&&this.sceneInfoSubscription.unsubscribe(),this.particleEmittersSubscription&&this.particleEmittersSubscription.unsubscribe(),this.statusSubscription&&this.statusSubscription.unsubscribe()}},{key:"connect",value:function(e,t){var n=this;this.transport.connect(e,t),this.statusSubscription=this.transport.status$.subscribe((function(e){if("error"===e&&console.log("Connection failed. Please contact an administrator."),n.connectionStatus=e,"connected"===e&&n.setupVisualization(),"ready"===e){var t=new l("/world/".concat(n.transport.getWorld(),"/dynamic_pose/info"),(function(e){e.pose.forEach((function(e){var t=n.scene.getByName("".concat(e.name).concat(e.id));t&&n.scene.setPose(t,e.position,e.orientation)}))}));n.transport.subscribe(t),n.sunLight=n.scene.createLight(3,new THREE.Color(.8,.8,.8),.9,{position:{x:0,y:0,z:10},orientation:{x:0,y:0,z:0,w:1}},null,!0,"sun",{x:.5,y:.1,z:-.9}),n.scene.add(n.sunLight),n.scene.ambient.color=new THREE.Color(6710886);var s=new l("/world/".concat(n.transport.getWorld(),"/scene/info"),(function(e){e&&e.model.forEach((function(e){for(var t=-1,s=0;s<n.models.length;++s)if(n.models[s].name===e.name){t=s;break}if(t<0){n.scene.getByName();var i=n.sdfParser.spawnFromObj({model:e},{enableLights:!1});e.gz3dName=i.name,n.models.push(e),n.scene.add(i)}else n.models[t].gz3dName="".concat(e.name).concat(e.id),n.models[t].id=e.id}))}));n.transport.subscribe(s)}})),this.sceneInfoSubscription=this.transport.sceneInfo$.subscribe((function(e){e&&("sky"in e&&e.sky&&n.scene.addSky(),n.sceneInfo=e,n.startVisualization(),e.model.forEach((function(e){var t=n.sdfParser.spawnFromObj({model:e},{enableLights:!1});e.gz3dName=t.name,n.models.push(e),n.scene.add(t)})),e.light.forEach((function(e){var t=n.sdfParser.spawnLight(e);n.scene.add(t)})),void 0!==e.ambient&&null!==e.ambient&&(n.scene.ambient.color=new THREE.Color(e.ambient.r,e.ambient.g,e.ambient.b)))}))}},{key:"setupVisualization",value:function(){var e=this;this.scene=new GZ3D.Scene(new GZ3D.Shaders,void 0,void 0,void 0,(function(t,n){e.transport.getAsset(t,n)})),this.sdfParser=new GZ3D.SdfParser(this.scene),this.sdfParser.usingFilesUrls=!0,this.sceneElement=window.document.getElementById("gz-scene"),this.sceneElement.appendChild(this.scene.renderer.domElement),this.scene.setSize(this.sceneElement.clientWidth,this.sceneElement.clientHeight)}},{key:"startVisualization",value:function(){var e=this;!function t(){e.scene.render(),e.cancelAnimation=requestAnimationFrame((function(){t()}))}()}},{key:"resize",value:function(){this.scene&&(console.log("REsize",this.sceneElement.clientWidth,this.sceneElement.clientHeight),this.scene.setSize(this.sceneElement.clientWidth,this.sceneElement.clientHeight))}},{key:"snapshot",value:function(){this.scene&&this.scene.saveScreenshot(this.transport.getWorld())}},{key:"resetView",value:function(){this.scene&&this.scene.resetView()}},{key:"follow",value:function(e){this.scene&&this.scene.emitter.emit("follow_entity",e)}},{key:"moveTo",value:function(e){this.scene&&this.scene.emitter.emit("move_to_entity",e)}},{key:"select",value:function(e){this.scene&&this.scene.emitter.emit("select_entity",e)}},{key:"getModels",value:function(){return this.models}}]),e}();/Mobi/.test(navigator.userAgent),e.Asset=c,e.Gamepad=u,e.Scene=h,e.Topic=l,e.Transport=d,e.binaryToBase64=function(e){for(var t="",n=e.byteLength,s=0;s<n;s++)t+=String.fromCharCode(e[s]);return window.btoa(t)},Object.defineProperty(e,"__esModule",{value:!0})}));
