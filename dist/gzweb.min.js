!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("rxjs"),require("protobufjs")):"function"==typeof define&&define.amd?define(["exports","rxjs","protobufjs"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).gzweb={},e.rxjs,e.protobufjs)}(this,(function(e,t,n){"use strict";function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}function i(e,t,n){return t&&o(e.prototype,t),n&&o(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function r(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,s=new Array(t);n<t;n++)s[n]=e[n];return s}function a(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return r(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?r(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var s=0,o=function(){};return{s:o,n:function(){return s>=e.length?{done:!0}:{done:!1,value:e[s++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,a=!0,u=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return a=e.done,e},e:function(e){u=!0,i=e},f:function(){try{a||null==n.return||n.return()}finally{if(u)throw i}}}}var u=function(){function e(){s(this,e),this.status$=new t.BehaviorSubject("disconnected"),this.sceneInfo$=new t.BehaviorSubject({}),this.availableTopics=[],this.topicMap=new Map,this.assetMap=new Map,this.world=""}return i(e,[{key:"connect",value:function(e,t){var n=this;this.disconnect(),this.ws=new WebSocket(e),this.ws.onopen=function(){return n.onOpen(t)},this.ws.onclose=function(){return n.onClose()},this.ws.onmessage=function(e){return n.onMessage(e)},this.ws.onerror=function(e){return n.onError(e)}}},{key:"disconnect",value:function(){this.ws&&this.ws.close()}},{key:"subscribe",value:function(e){this.topicMap.set(e.name,e);var t=this.availableTopics.filter((function(t){return t.topic===e.name}))[0];"ignition.msgs.Image"===t.msg_type||"gazebo.msgs.Image"===t.msg_type?this.ws.send(this.buildMsg(["image",e.name,"",""])):this.ws.send(this.buildMsg(["sub",e.name,"",""]))}},{key:"unsubscribe",value:function(e){if(this.topicMap.has(e)){var t=this.topicMap.get(e);void 0!==t&&void 0!==t.unsubscribe&&t.unsubscribe(),this.topicMap.delete(e),this.ws.send(this.buildMsg(["unsub",e,"",""]))}}},{key:"throttle",value:function(e,t){this.ws.send(this.buildMsg(["throttle",e.name,"na",t.toString()]))}},{key:"getAvailableTopics",value:function(){return this.availableTopics}},{key:"getSubscribedTopics",value:function(){return this.topicMap}},{key:"getWorld",value:function(){return this.world}},{key:"getAsset",value:function(e,t){var n={uri:e,cb:t};this.assetMap.set(e,n),this.ws.send(this.buildMsg(["asset","","",e]))}},{key:"onOpen",value:function(e){e?this.ws.send(this.buildMsg(["auth","","",e])):this.ws.send(this.buildMsg(["protos","","",""]))}},{key:"onClose",value:function(){this.topicMap.clear(),this.availableTopics=[],this.root=null,this.status$.next("disconnected"),this.sceneInfo$.next({})}},{key:"onMessage",value:function(e){var t=this,s=new FileReader;if(!this.root)return s.onloadend=function(){switch(s.result){case"authorized":t.ws.send(t.buildMsg(["protos","","",""]));break;case"invalid":console.error("Invalid key");break;default:t.root=n.parse(s.result,{keepCase:!0}).root,t.ws.send(t.buildMsg(["topics-types","","",""])),t.ws.send(t.buildMsg(["worlds","","",""])),t.status$.next("connected")}},void s.readAsText(e.data);s.onloadend=function(){var e,n,o,i;if(t.root){if("disconnected"!==t.status$.getValue()){var r,u=new TextDecoder("utf-8").decode(s.result).split(","),c=t.root.lookup(u[2]),l=new Uint8Array(s.result).slice(u[0].length+u[1].length+u[2].length+3);if(r="ignition.msgs.Image"===u[2]||"gazebo.msgs.Image"===u[2]?l:c.decode(l),"asset"==u[0])t.assetMap.has(u[1])?null===(n=null===(e=null==t?void 0:t.assetMap)||void 0===e?void 0:e.get(u[1]))||void 0===n||n.cb(r.data):console.error("No resource callback");else if("pub"==u[0])switch(u[1]){case"topics-types":var d,f=a(r.publisher);try{for(f.s();!(d=f.n()).done;){var h=d.value;t.availableTopics.push(h)}}catch(e){f.e(e)}finally{f.f()}break;case"topics":t.availableTopics=r.data;break;case"worlds":t.world=r.data[0],t.ws.send(t.buildMsg(["scene",t.world,"",""]));break;case"scene":t.sceneInfo$.next(r),t.status$.next("ready");break;default:t.topicMap.has(u[1])&&(null===(i=null===(o=null==t?void 0:t.topicMap)||void 0===o?void 0:o.get(u[1]))||void 0===i||i.cb(r))}else console.warn("Unhandled websocket message with frame operation",u[0])}}else console.error("Protobuf root has not been created")},s.readAsArrayBuffer(e.data)}},{key:"onError",value:function(e){this.status$.next("error"),this.disconnect(),console.error(e)}},{key:"buildMsg",value:function(e){return e.join(",")}}]),e}(),c=i((function e(t,n){s(this,e),this.name=t,this.cb=n})),l=i((function e(t,n){s(this,e),this.uri=t,this.cb=n}));/Mobi/.test(navigator.userAgent),e.Asset=l,e.Topic=c,e.Transport=u,e.binaryToBase64=function(e){for(var t="",n=e.byteLength,s=0;s<n;s++)t+=String.fromCharCode(e[s]);return window.btoa(t)},Object.defineProperty(e,"__esModule",{value:!0})}));
